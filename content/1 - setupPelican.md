Title: Blogging using Pelican + Conda + GitHub Pages
date: 2016-12-23 03:42
tags: Pelican, Python
category: How-To
author: Abraham Vinod
summary: All the tweaks I did to get my Pelican blog running.

# Prelude

I have been postponing my foray into blogging for some time now. Well, this
holiday season I decided to present myself with the gift of blogging. I had done
a bit of blogging using [DokuWiki](https://www.dokuwiki.org/) back when I was at
IIT Madras, but my site was hacked due to my neglience of the security settings.
To make things simple, I am choosing a static website for blogging this time. I will
stick with [Pelican](https://blog.getpelican.com/) due to my comfort level with
Python. 

On reading about Pelican, I discovered that the norm appears to be to replace the customary
"Hello World" post with a post on how one sets up the blog using Pelican.
The journey on understanding Pelican definitely is not straight-forward as one would like to hope for.
However, among the numerous posts I read on the internet, I would like to
especially thank the "Hello World" posts from Mr. Hartley's
[blog](http://beneathdata.com/how-to/how-i-built-this-website), Mr. Vincent's
[blog](http://algorithmshop.com/20131212-starting-a-blog.html/), and Mr.
Jerome's [blog](http://ntanjerome.org/blog/how-to-setup-github-user-page-with-pelican/).

# How did I get my blog setup?

## Setting up Conda and Pelican in Windows

Requirements:

1. [msysgit](https://git-for-windows.github.io/)[^1] to emulate the Unix terminal in my PC. 
1. [conda](https://github.com/conda/conda) for easy python package handling

The following steps create a virtual environment in conda for Pelican,
~~~bash
$ conda create -n blog python=3.5       # Creates a conda environment blog with Python 3.5
$ conda install markdown                # Install markdown
~~~
or download the following environment file [blog](stuff/blog.yml), and do
~~~bash
$ conda env create -f blog.yml
~~~
Note that pelican-quickstart of pelican (available through the conda-forge
[channel](https://anaconda.org/conda-forge/pelican)) does not work. It does
compile an existing pelican blog without any problems. 

To solve this, I fork the bleeding edge (at the time of writing, Pelican
3.7.0.dev0) of Pelican instead.  Unzip the [git
repository](https://github.com/getpelican/pelican/archive/master.zip) into a
directory of your choice, say `PelicanBase`.
~~~bash
$ source activate blog                  # Activate the conda environment
$ cd PelicanBase
$ python setup.py install               # Install pelican
~~~
This installs pelican and fab.

## Setting up the blog
At this point, we are now ready to start laying the foundation for the blog.
~~~bash
$ mkdir path/to/blog
$ cd path/to/blog
$ pelican-quickstart                    
~~~
<!-- 
# Should have worked, but will fail
You will have to replace the == in the line number given in the error message
with >=. See [this
conversation](https://github.com/getpelican/pelican/issues/2043#issuecomment-268625132)
for more details. 
--> 
`pelican-quickstart` will pose a series of questions that initializes
your blog.

## Creating the first post

Create `firstPost.md` containing a title and date[^2].
~~~bash
$ mkdir content
$ echo 'Title: Test content
> Date: 2016' > content/firstPost.md      # '>' is autogenerated when ENTER is pressed.
~~~

## Rendering the blog

Fabric is a great tool that works with Pelican to automate publishing.
~~~bash
$ fab build                             # Builds the blog
$ fab serve                             # Serves the blog at localhost:8000 while holding up the terminal
$ fab regenerate & fab serve &          # Serves the blog at localhost:8000 while freeing the terminal
~~~
I use the third command to work with my blog while typing. The automation
renders the new blog when the webpage is refreshed. To further automate the
refreshing (preview style), you can look into plugins for your favorite
browser. In Firefox, AutoReload is a good add-on.
    
## Updating github pages

I have used the approach highlighted in [this Hello World
post](http://ntanjerome.org/blog/how-to-setup-github-user-page-with-pelican/).
To summarize [that
post](http://ntanjerome.org/blog/how-to-setup-github-user-page-with-pelican/),

1. Ensure that you are on the 'source' branch (Create a new one using `git
checkout -b source` if you haven't already)
+ Add/commit everything except the `output` folder 
+ Create a new branch 'gh-pages'
+ Run the following bash script to automate the *updation of GitHub pages*

I had to also follow the advice given
[here](https://github.com/getnikola/nikola/issues/2223#issuecomment-174193643)
to install ghp-import via 
~~~bash
pip install --upgrade git+https://github.com/ionelmc/python-ghp-import
~~~
as opposed to the standard Conda installation. 

Once ghp-import is properly installed, I use the following script to 
```bash
commitMSG="$1"
echo $commitMSG
fab build
git commit -am "$commitMSG"
ghp-import output
git checkout master
git merge gh-pages -m "$commitMSG"
git pull
git push -u --all
git checkout source
```
Future updates at Github with the local copy is now easy.
~~~bash
source bp "Commit Message"
~~~

# Other tweaks

## Adding RSS

Include in your `pelicanconf.py`, the following lines
~~~python
# Feed generation
FEED_ALL_RSS = 'feeds/all.rss'
FEED_ALL_ATOM = None
CATEGORY_FEED_ATOM = None #'feeds/%s.atom.xml'
TRANSLATION_FEED_ATOM = None
~~~

## Ignoring drafts

Include in your `pelicanconf.py`, the following lines
~~~python
# Private sandbox
IGNORE_FILES = ['0PRIVATE*']  # Pelican does not generate html pages for md files starting with 0Private
~~~
Another
[option](http://www.stevenmaude.co.uk/posts/hiding-draft-articles-in-pelican)is
to use `Status: draft` in the markdown article header to ask Pelican to put the
generated htmls in a separate folder `drafts/`. Remember to add this to
`.gitignore` of the master branch to ensure it doesn't get pushed to the
outside world.

## Pelican-Bootstrap3

Clone `pelican-bootstrap3` into the root folder of the blog.
```python
####################### Theme-Specific Settings #########################
THEME = 'pelican-bootstrap3'        #'html5-dopetrope'

# Pelican Theme-Specific Variables
BOOTSTRAP_THEME = 'cosmo'
PYGMENTS_STYLE = 'monokai'
SHOW_ARTICLE_CATEGORY = True

ABOUT_ME = "blah blah blah"

AVATAR = "/images/myphoto.png"

DISPLAY_ARTICLE_INFO_ON_INDEX = True
DISPLAY_TAGS_ON_SIDEBAR = False
SHOW_ARTICLE_CATEGORY = True
DISPLAY_RECENT_POSTS_ON_SIDEBAR = False
# Below commands will generate SITEURL/tags.html which will have the list of tags
TAG_SAVE_AS = 'tags/{slug}.html'
TAGS_SAVE_AS = 'tags.html'
DIRECT_TEMPLATES=['index','tags','categories','archives']

```
<!---
#BANNER = "/images/banner.png"
#SITELOGO = 'images/logo.png'
#SITELOGO_SIZE = 32
#FAVICON = 'images/favicon.png'
--->

### Reducing the figure size

Edit the `.entry-content img` in `pelican-bootstrap3/static/css/style.css` to
have a `max-width` of 80%. This ensures my MATLAB generated files are not
displayed very big (See [this blog post]({filename}8 - hscc2017.md)).

### Custom header bar

Add the following block within the if loop but just above the code 
`{% for cat, null in categories %}` in `pelican-bootstrap3/templates/base.html`.
```
<!-- Addition of My research tag into the header-->
<li>
    <a href="{{ SITEURL }}/tags/my-research.html">My
        Research</a>
</li>
```
## Math support

I could not get the `render_math` plugin to work. I just incorporated MathJax
into the `pelican-bootstrap3\templates\base.html` of my template based on the [MathJax
documentation](http://docs.mathjax.org/en/latest/start.html#tex-and-latex-input).
Insert the following snippet before the `</head>` tag in `base.html`.
~~~html
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({tex2jax: {inlineMath: [['$','$'], ['\\(','\\)']]}});
</script>
<script type="text/javascript" async
  src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS_CHTML">
</script>
~~~
This will produce beautiful math like $x^2$ and $$A_B.$$ 

## Plugins

~~~python
PLUGIN_PATHS = ['pelican-plugins']

PLUGINS = ['pelican-toc']
TOC = {
    'TOC_HEADERS' : '^h[1-6]',  # What headers should be included in the generated toc
                                # Expected format is a regular expression

    'TOC_RUN'     : 'true'      # Default value for toc generation, if it does not evaluate
                                # to 'true' no toc will be generated
}
~~~
<!-- #MD_EXTENSIONS = ['toc', 'fenced_code', 'codehilite(css_class=highlight)',
'extra'] -->

### Table of contents
Insert this block in `pelican-bootstrap3\templates\base.html` just above the
`{{article.content}}`.
~~~python
{% if article.toc %}
    <div style="border-style: solid;background:lightgrey">
        <h3 style="text-align:center"> Table of contents</h3>
            <nav class="toc">
            {{ article.toc }}
            </nav>
    </div>
{% endif %}
~~~

## Changing footer


Based on this
[article](http://mygeekdaddy.net/2015/01/09/never-change-your-pelican-footer-again/),
I updated `blog/pelican-bootstrap3/templates/includes/footer.html` with
~~~html
<footer>
   <div class="container">
      <hr>
      <div class="row">
         {% if articles %}
            {% set copy_date = articles[0].date.strftime('%Y') %}
         {% else %}
            {% set copy_date = '' %}
         {% endif %}
         <div class="col-xs-10">&copy; {{ copy_date }} {{ AUTHOR }}
            &middot; Powered by <a href="http://docs.getpelican.com/"
                target="_blank">Pelican</a> and other  <a
            href="http://abyvinod.github.io/setting-up-this-blog-using-the-pelicancondagithub-pages.html"
                target="_blank">goodies</a>.
         </div>
         <div class="col-xs-2"><p class="pull-right"><i class="fa fa-arrow-up"></i> <a href="#">Back to top</a></p></div>
      </div>
   </div>
</footer>
~~~

[^1]: $ sign denotes bash prompt.
[^2]: Title and date is the minimum requirement for a blog post.
